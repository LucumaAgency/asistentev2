# Contexto y Estado del Proyecto - 15 de Enero 2025

## Resumen del Trabajo Realizado

### Problema Principal
La aplicaci√≥n AI Assistant v2 ten√≠a problemas cr√≠ticos con la integraci√≥n de Google Calendar:
1. Los tokens OAuth no se estaban guardando en la base de datos
2. La IA no pod√≠a agendar reuniones aunque el usuario hab√≠a autorizado Calendar
3. Los eventos no se mostraban correctamente en la UI ("loop con info invalida")

### Soluciones Implementadas

#### v3.27 - Fix Cr√≠tico de Tokens para IA
- **Problema**: La IA no pod√≠a acceder a los tokens de Calendar
- **Causa**: Query SQL faltaba filtro `service = "google_calendar"`
- **Soluci√≥n**: Corregido en `server.cjs` l√≠nea 619:
  ```sql
  SELECT access_token, refresh_token, token_type, expires_at 
  FROM user_tokens 
  WHERE user_id = ? AND service = "google_calendar"
  ```

#### v3.28 - Fix de Visualizaci√≥n de Eventos
- **Problema**: Frontend recib√≠a eventos con formato incorrecto causando "loop con info invalida"
- **Causa**: Los eventos de Google Calendar API tienen campos diferentes (`summary` vs `title`)
- **Soluci√≥n**: Formatear eventos antes de enviar al frontend:
  ```javascript
  const formattedEvents = events.map(event => ({
    id: event.id,
    title: event.summary || 'Sin t√≠tulo',
    start: event.start?.dateTime || event.start?.date,
    end: event.end?.dateTime || event.end?.date,
    meetLink: event.conferenceData?.entryPoints?.[0]?.uri
  }));
  ```

### Estado Actual del Sistema

#### ‚úÖ Funcionando
- Autenticaci√≥n OAuth con Google
- Creaci√≥n de eventos desde UI (bot√≥n Calendar)
- Visualizaci√≥n de eventos en Calendar modal
- Google Meet se a√±ade autom√°ticamente a eventos
- Funciones de Calendar definidas para la IA

#### ‚ö†Ô∏è Pendiente de Verificaci√≥n
- **Tokens no guardados**: Usuario necesita re-autorizar Calendar
- **Modo Calendar**: Existe en BD pero usuario debe seleccionarlo en chat
- **IA Calendar**: Funciona pero requiere tokens guardados

### Diagn√≥stico Actual

#### Base de Datos
```
Database: asistente_test
Tablas relevantes:
- users (1 usuario: carlosmurilloortecho@gmail.com)
- user_tokens (VAC√çA - problema principal)
- modes (tiene modo Calendar con id=2, mode_id='calendar')
- chat_sessions
```

#### Modo Calendar Configurado
```sql
id: 2
mode_id: calendar
name: üìÖ Calendario
prompt: [Configurado con instrucciones para gesti√≥n de calendario]
```

#### Funciones de IA Disponibles
1. `schedule_meeting` - Crear eventos con Google Meet
2. `check_availability` - Verificar disponibilidad
3. `list_events` - Listar eventos
4. `find_next_available` - Buscar pr√≥ximo horario libre
5. `get_current_datetime` - Obtener fecha/hora actual

### Herramientas de Debug Creadas

#### 1. Endpoint de Estado
```
GET /api/test/ai-calendar-status
```
Verifica:
- Tokens guardados en BD
- Modo Calendar configurado
- Sesiones de chat en modo Calendar
- Estado del usuario actual

#### 2. Script de Debug
```bash
node debug-ai-calendar.cjs
```
Analiza:
- Usuarios con tokens
- Configuraci√≥n del modo Calendar
- Sesiones activas

#### 3. Logs Detallados
- OAuth debug en `routes/auth.cjs`
- Calendar operations en `server.cjs`
- Token validation en middleware

### Pasos para Activar IA Calendar

1. **Re-autorizar Calendar** (CR√çTICO)
   - Cerrar sesi√≥n
   - Iniciar sesi√≥n con Google
   - Autorizar permisos de Calendar

2. **Verificar tokens guardados**
   ```javascript
   fetch('/api/test/ai-calendar-status', {
     headers: {'Authorization': 'Bearer ' + localStorage.getItem('token')}
   }).then(r => r.json()).then(console.log)
   ```

3. **Usar modo Calendar en chat**
   - Seleccionar "üìÖ Calendario"
   - Probar: "Crea una reuni√≥n para ma√±ana a las 3 PM"

### Archivos Clave Modificados

#### Backend
- `/server.cjs` - Endpoints de Calendar, funciones IA, fix de tokens
- `/services/googleCalendar.cjs` - Fix array vac√≠o, formato fechas ISO
- `/routes/auth.cjs` - Debug extensivo de guardado de tokens
- `/middleware/calendarAuth.cjs` - Validaci√≥n de tokens
- `/db-connection.cjs` - M√≥dulo compartido de conexi√≥n BD

#### Frontend  
- `/frontend/src/components/CalendarEvents.jsx` - UI de Calendar
- `/frontend/src/components/LoginWithCalendar.jsx` - v3.28

#### Configuraci√≥n
- `/create-calendar-mode.sql` - Script para crear modo en BD
- `/FIX-IA-CALENDAR.md` - Instrucciones detalladas
- `/test-ai-calendar-status.cjs` - Endpoint diagn√≥stico

### Deployment
- GitHub Actions workflow configurado
- Despliega autom√°ticamente a rama `production`
- Plesk pull desde `production` branch
- Frontend build incluido en deployment

### Pr√≥ximos Pasos Recomendados

1. **Inmediato**: Usuario debe re-autorizar Calendar
2. **Verificar**: Que tokens se guarden correctamente
3. **Probar**: IA en modo Calendar con comandos de prueba
4. **Opcional**: A√±adir retry autom√°tico si tokens expiran
5. **Mejorar**: Mensajes de error m√°s descriptivos para usuario

### Notas T√©cnicas

- La BD usa `modes` no `assistant_modes`
- El `mode_id` para Calendar es `'calendar'` (string)
- El `id` en BD es `2` (n√∫mero)
- Los tokens deben tener `service = 'google_calendar'`
- JWT usa `userId` num√©rico, no `google_id` string

### Versiones Desplegadas
- v3.27: Fix SQL query para tokens de IA
- v3.28: Fix formato de eventos para UI
- Endpoint de diagn√≥stico a√±adido

---
Generado: 15 de Enero 2025, 02:30 AM
Estado: Calendar funcional en UI, pendiente activaci√≥n completa de IA